## TODO: Modularize the gitlab yaml to reuse templates

## Define the stages & order of execution

stages:
  - CLUSTER-SETUP
  - PROVIDER-INFRA-SETUP
  - STATEFUL-APP-DEPLOY
  - NODE-MAINTENANCE-DRAIN
  - NODE-LOSS-EVICT
  - STORAGE-POOL-FAILURE
  - CLUSTER-CLEANUP

variables: 
  utils_path: "/openebs/e2e-aws/script/utils"

## Setup the kubernetes cluster

aws-cluster:
  image: atulabhi/kops:v8
  stage: CLUSTER-SETUP 
  script: 
    - ./script/aws
  artifacts:
    paths:
      - aws/

## Setup OpenEBS control plane

openebs-aws-deploy:
  image: atulabhi/kops:v8
  stage: PROVIDER-INFRA-SETUP
  dependencies:
    - aws-cluster
  before_script:  
   - ./script/provider/infra-setup
  script: 
   - ./script/provider/cstor/cstor-disk-pool-provision
  artifacts:
    paths:
      - aws-openebs/

## Define a job template for app deployers

.app_deploy_template:
  image: atulabhi/kops:v8
  stage: STATEFUL-APP-DEPLOY 
  dependencies:
    - openebs-aws-deploy
  artifacts:
    paths: 
      - aws-openebs/

## Define the app deployer jobs

# PERCONA-CSTOR
percona-cstor-run/load/check 0:3:
  extends: .app_deploy_template
  script: 
   - ./script/apps/percona/deployer/percona-app-deploy-cstor

percona-cstor-run/load/check 1:3:
  extends: .app_deploy_template
  script: 
   - ./script/apps/percona/workload/percona-app-workload-cstor


## Define job template for chaos jobs 

.chaos_test_template:
  image: atulabhi/kops:v8
  when: always 
  artifacts:
    paths: 
      - aws-openebs/

node-maintenance-via-drain:
  stage: NODE-MAINTENANCE-DRAIN
  extends: .chaos_test_template #dependencies: percona-cstor
  before_script:
   - ./script/apps/percona/liveness/percona-app-liveness-cstor
  script:
   - ./script/chaos/node-maintenance-via-drain

node-loss-via-evict:
  stage: NODE-LOSS-EVICT
  extends: .chaos_test_template #dependencies: percona-cstor
  before_script:
   - ./script/apps/percona/liveness/percona-app-liveness-cstor
  script:
   - ./script/chaos/nodeloss-via-pod-evict

storage-pool-failure 0:2:
  stage: STORAGE-POOL-FAILURE
  extends: .chaos_test_template #dependencies: percona-cstor
  before_script:
   - ./script/apps/percona/liveness/percona-app-liveness-cstor
  script:
   - ./script/chaos/cstor-pool-pod-delete

storage-pool-failure 1:2:
  stage: STORAGE-POOL-FAILURE
  extends: .chaos_test_template #dependencies: percona-cstor
  before_script:
   - ./script/apps/percona/liveness/percona-app-liveness-cstor
  script:
   - ./script/chaos/cstor-pool-pod-kill

cleanup-aws:
  when: always
  image: atulabhi/kops:v8
  dependencies:
    - aws-cluster
  stage: CLUSTER-CLEANUP
  script: 
    - chmod 755 ./script/aws-cleanup
    - ./script/aws-cleanup
